{% extends 'base.html' %}

{% block content %}
  <h1 class="title">Prompts in category: {{ category.name }}</h1>
  <div class="columns is-multiline">
    {% for prompt in prompts %}
      <div class="column is-one-third">
        <div class="box">
          <div class="content">
            <p data-prompt-id="{{ prompt.id }}" data-full-text="{{ prompt.text }}">{{ prompt.text|truncatechars:250 }} <span class="tag is-light">Length: {{ prompt.text|length }} chars...</span></p>
            <div class="tags">
              {% for id, label in prompt_labels %}
                {% if id == prompt.id %}
                  {% for label_val in label %} 
                  <a href="{% url 'list_prompts_by_label' label_val.id %}"><span class="tag is-rounded">{{ label_val.name }}</span></a>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <button class="button is-small" data-clipboard-text="{{ prompt.text }}">
            <span class="icon">
              <i class="fas fa-copy"></i>
            </span>
          </button>
          <button class="button is-small" onclick="openEditPrompt({{ prompt.id }})">
            <span class="icon">
              <i class="fas fa-edit"></i>
            </span>
          </button>
        </div>
      </div>
      {% empty %}
        <div class="column is-full">
          <div class="box has-text-centered" style="height: 200px; display: flex; align-items: center; justify-content: center;">
            <h3 class="subtitle">No prompts. Here's a cookie <svg style="height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M247.2 17c-22.1-3.1-44.6 .9-64.4 11.4l-74 39.5C89.1 78.4 73.2 94.9 63.4 115L26.7 190.6c-9.8 20.1-13 42.9-9.1 64.9l14.5 82.8c3.9 22.1 14.6 42.3 30.7 57.9l60.3 58.4c16.1 15.6 36.6 25.6 58.7 28.7l83 11.7c22.1 3.1 44.6-.9 64.4-11.4l74-39.5c19.7-10.5 35.6-27 45.4-47.2l36.7-75.5c9.8-20.1 13-42.9 9.1-64.9l-14.6-82.8c-3.9-22.1-14.6-42.3-30.7-57.9L388.9 57.5c-16.1-15.6-36.6-25.6-58.7-28.7L247.2 17zM208 144a32 32 0 1 1 0 64 32 32 0 1 1 0-64zM144 336a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm224-64a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></h3>
          </div>
        </div>
    {% endfor %}
  </div>

  <div class="modal" id="editPromptModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Edit Prompt</p>
        <button class="delete" aria-label="close" onclick="closeEditPrompt()"></button>
      </header>
      <section class="modal-card-body">
        <input type="hidden" id="editPromptId">
        <textarea class="textarea" id="editPromptText" rows="10"></textarea>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" onclick="saveEditPrompt()">Save</button>
        <button class="button" onclick="closeEditPrompt()">Cancel</button>
      </footer>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
  <script>
    new ClipboardJS('.button');

    // Custom functions for displaying popup
    function openEditPrompt(promptId) {
      document.getElementById('editPromptId').value = promptId;
      const promptText = document.querySelector(`[data-prompt-id="${promptId}"]`).dataset.fullText;
      document.getElementById('editPromptText').value = promptText;
      document.getElementById('editPromptModal').classList.add('is-active');
    }
  
    function closeEditPrompt() {
      document.getElementById('editPromptModal').classList.remove('is-active');
    }
  
    async function saveEditPrompt() {
      const promptId = document.getElementById('editPromptId').value;
      const newText = document.getElementById('editPromptText').value;
  
      const response = await fetch(`/prompts/edit/${promptId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ 'text': newText })
      });
  
      if (response.ok) {
        location.reload();
      } else {
        alert('Error: Unable to save the updated prompt');
      }
    }
  </script>
{% endblock %}
